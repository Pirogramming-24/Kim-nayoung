{% extends 'base.html' %}
{% load static %}
{% block head %}
<title>상품 등록</title>
<link rel="stylesheet" href="{% static 'posts/css/post_create.css' %}">
{% endblock %}

{% block content %}
<h2>상품 등록</h2>

<form action="{% url 'posts:create' %}" method="POST" enctype="multipart/form-data">
    {% csrf_token %}
    
    {{ form.as_p }}
    
    <button class="btn btn-success">등록하기</button>
</form>

<script>
    const NUTRITION_INPUT_ID = 'id_nutrition_image'; 
    const targetFields = {
        calorie: document.getElementById('id_calorie'),
        carbohydrate: document.getElementById('id_carbohydrate'),
        protein: document.getElementById('id_protein'),
        fat: document.getElementById('id_fat')
    };

    const nutritionInput = document.getElementById(NUTRITION_INPUT_ID);

    if (nutritionInput) {
        nutritionInput.addEventListener('change', async function() {
            if (!this.files[0]) return;

            for (let key in targetFields) {
                const el = targetFields[key];
                if (el) {
                    el.dataset.originalType = el.type;
                    el.type = 'text';
                    el.value = '분석 중...';
                }
            }

            // 3. 서버로 이미지 전송 (비동기)
            const formData = new FormData();
            formData.append('image', this.files[0]);

            try {
                // 주의: URL은 실제 ocr_extract 뷰의 URL 이름에 맞춰야 합니다.
                const response = await fetch("{% url 'posts:ocr_extract' %}", {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();

                // 4. 결과 처리
                if (result.success) {
                    const data = result.data;
                    
                    // 값 채우기 (함수 호출)
                    setFieldValue(targetFields.calorie, data.calorie);
                    setFieldValue(targetFields.carbohydrate, data.carbohydrate);
                    setFieldValue(targetFields.protein, data.protein);
                    setFieldValue(targetFields.fat, data.fat);
                } else {
                    alert("분석 실패: " + (result.error || "글자를 찾을 수 없습니다."));
                    resetFields();
                }
            } catch (error) {
                console.error("OCR Error:", error);
                alert("서버 통신 중 오류가 발생했습니다.");
                resetFields();
            }
        });
    } else {
        console.error(`ID가 '${NUTRITION_INPUT_ID}'인 파일 입력창을 찾을 수 없습니다. HTML ID를 확인해주세요.`);
    }

    // [헬퍼 함수] 값을 채우고 원래 타입(number)으로 복구
    function setFieldValue(element, value) {
        if (!element) return;
        element.value = value; 
        element.type = element.dataset.originalType || 'number';
        element.classList.remove('analyzing');
    }

    // [헬퍼 함수] 에러 시 빈칸으로 초기화
    function resetFields() {
        for (let key in targetFields) {
            const el = targetFields[key];
            if (el) {
                el.value = '';
                el.type = el.dataset.originalType || 'number';
                el.classList.remove('analyzing');
            }
        }
    }
</script>
{% endblock %}